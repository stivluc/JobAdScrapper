{% extends "base.html" %}

{% block title %}Configuration - Job Ad Scraper{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1><i class="fas fa-cog"></i> Configuration</h1>
        <p class="lead">Personnalisez les paramètres du scraper selon vos critères</p>
    </div>
</div>

<!-- Configuration actuelle -->
<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-user"></i> Profil actuel</h5>
            </div>
            <div class="card-body">
                {% if config_data %}
                    <div class="mb-3">
                        <strong>Expérience:</strong> {{ config_data.user_profile.experience_years }} ans<br>
                        <strong>Niveau:</strong> {{ config_data.user_profile.education_level }}
                    </div>
                    
                    <div class="mb-3">
                        <strong>Compétences:</strong>
                        <div class="mt-2">
                            {% for skill in config_data.user_profile.skills.split(', ')[:8] %}
                                <span class="badge bg-primary me-1 mb-1">{{ skill }}</span>
                            {% endfor %}
                            {% if config_data.user_profile.skills.split(', ')|length > 8 %}
                                <span class="badge bg-secondary">+{{ config_data.user_profile.skills.split(', ')|length - 8 }} autres</span>
                            {% endif %}
                        </div>
                    </div>
                {% else %}
                    <p class="text-muted">Erreur lors du chargement du profil</p>
                {% endif %}
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-search"></i> Critères de recherche</h5>
            </div>
            <div class="card-body">
                {% if config_data %}
                    <div class="mb-3">
                        <strong>Postes recherchés:</strong>
                        <div class="mt-2">
                            {% for keyword in config_data.search_criteria.keywords[:3] %}
                                <span class="badge bg-success me-1 mb-1">{{ keyword }}</span>
                            {% endfor %}
                            {% if config_data.search_criteria.keywords|length > 3 %}
                                <span class="badge bg-secondary">+{{ config_data.search_criteria.keywords|length - 3 }} autres</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <strong>Localisations:</strong>
                        <div class="mt-2">
                            {% for location in config_data.search_criteria.locations[:3] %}
                                <span class="badge bg-info me-1 mb-1">{{ location }}</span>
                            {% endfor %}
                            {% if config_data.search_criteria.locations|length > 3 %}
                                <span class="badge bg-secondary">+{{ config_data.search_criteria.locations|length - 3 }} autres</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <strong>Salaire:</strong> {{ config_data.search_criteria.salary_min }}€ - {{ config_data.search_criteria.salary_max }}€<br>
                        <strong>Télétravail:</strong> {% if config_data.search_criteria.remote_ok %}✅ Oui{% else %}❌ Non{% endif %}
                    </div>
                {% else %}
                    <p class="text-muted">Erreur lors du chargement des critères</p>
                {% endif %}
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-wrench"></i> Paramètres scraper</h5>
            </div>
            <div class="card-body">
                {% if config_data %}
                    <div class="mb-2">
                        <strong>Requêtes Google max:</strong> {{ config_data.scraper_settings.max_google_queries }}<br>
                        <strong>Offres max:</strong> {{ config_data.scraper_settings.max_jobs_total }}<br>
                        <strong>Délai entre requêtes:</strong> {{ config_data.scraper_settings.delay_between_queries }}s<br>
                        <strong>Mode headless:</strong> {% if config_data.scraper_settings.headless %}✅ Oui{% else %}❌ Non{% endif %}
                    </div>
                {% else %}
                    <p class="text-muted">Erreur lors du chargement des paramètres</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-edit"></i> Éditeur de configuration</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('save_config') }}">
                    <div class="mb-3">
                        <label for="config_content" class="form-label">
                            Fichier config.yaml
                            <small class="text-muted">(Soyez prudent avec la syntaxe YAML)</small>
                        </label>
                        <textarea 
                            class="form-control config-editor" 
                            id="config_content" 
                            name="config_content" 
                            rows="25"
                            spellcheck="false">{{ config_content }}</textarea>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <div>
                            <button type="submit" class="btn btn-success me-3">
                                <i class="fas fa-save"></i> Sauvegarder la configuration
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="resetConfig()">
                                <i class="fas fa-undo"></i> Annuler les modifications
                            </button>
                        </div>
                        <div>
                            <button type="button" class="btn btn-outline-info me-2" onclick="validateYaml()">
                                <i class="fas fa-check"></i> Valider YAML
                            </button>
                            <button type="button" class="btn btn-outline-warning" onclick="showTemplate()">
                                <i class="fas fa-file-code"></i> Template
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Aide et documentation -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-question-circle"></i> Aide et documentation</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6><i class="fas fa-user-cog"></i> Profil utilisateur</h6>
                        <ul class="list-unstyled">
                            <li><strong>skills:</strong> Compétences séparées par des virgules</li>
                            <li><strong>experience_years:</strong> Nombre d'années d'expérience</li>
                            <li><strong>education_level:</strong> Niveau d'éducation</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h6><i class="fas fa-target"></i> Critères de recherche</h6>
                        <ul class="list-unstyled">
                            <li><strong>keywords:</strong> Liste des types de postes</li>
                            <li><strong>locations:</strong> Liste des localisations</li>
                            <li><strong>salary_min/max:</strong> Fourchette salariale</li>
                            <li><strong>remote_ok:</strong> Télétravail accepté (true/false)</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h6><i class="fas fa-cloud"></i> Configuration API</h6>
                        <ul class="list-unstyled">
                            <li><strong>enabled_sources:</strong> Sources d'emploi activées</li>
                            <li><strong>max_results_per_source:</strong> Limite par API</li>
                            <li><strong>api_delay:</strong> Délai entre requêtes API</li>
                            <li><strong>min_match_score:</strong> Score minimum (0-100)</li>
                        </ul>
                    </div>
                </div>
                
                <div class="alert alert-warning mt-3">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Attention:</strong> Une configuration incorrecte peut empêcher le scraper de fonctionner.
                    Assurez-vous de respecter la syntaxe YAML et validez vos modifications.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour le template -->
<div class="modal fade" id="templateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Template de configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Voici un template de base pour la configuration :</p>
                <pre><code class="language-yaml" id="template-code"># Configuration du scraper d'emploi moderne
user_profile:
  skills: "Python, JavaScript, React, Node.js, TypeScript, SQL"
  experience_years: 5
  education_level: "Ingénieur"

search_criteria:
  keywords: ["développeur full stack", "ingénieur logiciel", "tech lead"]
  locations: ["Genève, Suisse", "Lausanne, Suisse", "télétravail"]
  salary_min: 50000
  salary_max: 120000
  remote_ok: true

api_settings:
  enabled_sources:
    - 'adzuna_api'
    - 'indeed_rss'
    - 'rapidapi_jobs'
  max_results_per_source: 25
  api_delay: 2
  api_timeout: 15

scraper_settings:
  max_jobs_total: 100
  min_match_score: 30
  random_delay_min: 3
  random_delay_max: 6

scoring_criteria:
  skills_weight: 40
  location_weight: 30
  remote_weight: 15
  source_weight: 15</code></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-primary" onclick="copyTemplate()">
                    <i class="fas fa-copy"></i> Copier le template
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function validateYaml() {
    const content = document.getElementById('config_content').value;
    
    // Validation basique côté client
    try {
        // Vérification de base de la syntaxe
        if (!content.trim()) {
            alert('Le fichier de configuration est vide');
            return;
        }
        
        // Vérification des sections requises
        if (!content.includes('user_profile:')) {
            alert('Section "user_profile" manquante');
            return;
        }
        
        if (!content.includes('search_criteria:')) {
            alert('Section "search_criteria" manquante');
            return;
        }
        
        if (!content.includes('api_settings:')) {
            alert('Section "api_settings" manquante');
            return;
        }
        
        if (!content.includes('scraper_settings:')) {
            alert('Section "scraper_settings" manquante');
            return;
        }
        
        if (!content.includes('scoring_criteria:')) {
            alert('Section "scoring_criteria" manquante');
            return;
        }
        
        alert('✅ Configuration API moderne valide!');
        
    } catch (error) {
        alert('❌ Erreur de validation: ' + error.message);
    }
}

function resetConfig() {
    if (confirm('Êtes-vous sûr de vouloir annuler toutes les modifications ?')) {
        location.reload();
    }
}

function showTemplate() {
    const modal = new bootstrap.Modal(document.getElementById('templateModal'));
    modal.show();
}

function copyTemplate() {
    const template = document.getElementById('template-code').textContent;
    navigator.clipboard.writeText(template).then(() => {
        alert('Template copié dans le presse-papiers');
    });
}

// Améliorer l'éditeur avec la coloration syntaxique
document.addEventListener('DOMContentLoaded', function() {
    const editor = document.getElementById('config_content');
    
    // Ajout de numéros de ligne
    editor.addEventListener('input', function() {
        const lines = this.value.split('\n').length;
        // Ici on pourrait ajouter des numéros de ligne
    });
    
    // Raccourcis clavier
    editor.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            document.querySelector('form').submit();
        }
    });
});
</script>

<style>
/* Code preview styling */
pre code {
    background-color: #1e293b !important;
    color: #f8fafc !important;
    border: 1px solid var(--border-light);
    border-radius: 0.375rem;
    padding: 1rem;
    font-size: 13px;
    line-height: 1.3;
    font-family: 'SF Mono', 'Monaco', 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
}

.badge {
    font-size: 0.8em;
}

/* Additional button spacing improvements */
.btn + .btn {
    margin-left: 0.75rem !important;
}

/* Specific button spacing overrides */
.btn.me-3 + .btn {
    margin-left: 1rem !important;
}

.btn.me-2 + .btn {
    margin-left: 0.75rem !important;
}
</style>
{% endblock %}